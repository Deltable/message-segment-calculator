<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Messaging Segment Calculator</title>
    <link rel="stylesheet" href="./main.css" />
    <script type="text/javascript" src="./grapheme-splitter.js"></script>
    <script type="text/javascript" src="./segments_calculator.js"></script>
    <script type="text/javascript" src="./segments_viewer.js"></script>
  </head>

  <body>
    <h1>Messaging Segment Calculator</h1>
    <div id="calculator">
      <div id="calculator-header">
        <div id="message-box">
          <label class="label" for="message">SMS Message </label>
          <textarea class="" type="text" id="message" name="message"></textarea>
        </div>

        <div id="information-box">
          <div id="encoding"></div>
          <div id="encoding-used"></div>
          <span class="label">Number of segments</span>
          <span class="value" id="segment-counter"></span>

          <span class="label">Number of characters</span>
          <span class="value" id="unicode-char-counter"></span>
        </div>
      </div>
    </div>
    <!-- test -->

    <script>
      const graphemeSplitter = new GraphemeSplitter();
      const messageBox = document.getElementById("message");
      const encodingSelect = document.getElementById("encoding");
      const encodingUsed = document.getElementById("encoding-used");

      const messageViewer = new MessageViewer(
        document.getElementById("message-viewer"),
        5
      );
      const segmentsViewer = new SegmentsViewer(
        document.getElementById("segments-viewer"),
        5
      );

      const counters = {
        segments: document.getElementById("segment-counter"),
        unicodeCharCounter: document.getElementById("unicode-char-counter"),
        unicodeScalarCounter: document.getElementById("unicode-scalar-counter"),
        messageSize: document.getElementById("message-size-counter"),
        totalSize: document.getElementById("total-size-counter"),
      };

      function updateCalculator() {
        const messageBodyText = messageBox.value;
        const encoding = encodingSelect.value;

        const segmentedMessage = new SegmentedMessage(
          messageBodyText,
          encoding,
          graphemeSplitter
        );

        counters.segments.textContent = segmentedMessage.segments.length;
        counters.unicodeCharCounter.textContent = graphemeSplitter.countGraphemes(
          messageBodyText
        );
        counters.unicodeScalarCounter.textContent = [...messageBodyText].length;
        counters.messageSize.textContent = `${segmentedMessage.messageSize} bits`;
        counters.totalSize.textContent = `${segmentedMessage.totalSize} bits`;

        messageViewer.update(segmentedMessage);
        segmentsViewer.update(segmentedMessage);
      }

      function selectBlocks(event) {
        const block = event.target.closest(".block");
        if (block) {
          const mapKey = block.getAttribute("data-key");

          if (mapKey) {
            messageViewer.select(mapKey);
            segmentsViewer.select(mapKey);
          }
        }
      }

      function clearSelection(event) {
        messageViewer.clearSelection();
        segmentsViewer.clearSelection();
      }

      messageBox.oninput = (event) => {
        updateCalculator();
      };
      updateCalculator();
    </script>
  </body>
</html>
